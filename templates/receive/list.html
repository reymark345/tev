{% extends 'index.html' %} {% block content %} {% load staticfiles %}

<!-- Content wrapper -->
<div class="content-wrapper">
    <!-- Content -->
    <div class="container-fluid flex-grow-1 container-p-y">
        <h4 class="fw-bold py-3 mb-4"><span class="text-muted fw-light">Item /</span> List</h4>

        <!-- DataTable with Buttons -->
        <div class="card">
            <div class="card-datatable table-responsive pt-0">
                <table id="tbl-items" class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="check-all"></th>
                            <th>Transaction Code</th>
                            <th>Id Number</th>
                            <th>Employee Name</th>
                            <th>Actual Amount</th>
                            <th>Final Amount</th>
                            <th>Travel Date</th>
                            <th>Status</th>
                            <th>Incoming In</th>
                            <th>Slashed Out</th>
                            <th>Remarks</th>
                            <th>Created By</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Edit User Modal -->
<div class="modal fade" id="advance-filter" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg modal-simple modal-edit-user">
    <div class="modal-content p-3 p-md-5">
    <div class="modal-body">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="text-center mb-4">
        <h3 class="mb-2">Advanced Filter </h3>
        <p class="text-muted">Filter data by filling the details below</p>
        </div>
        <form id="advanced-filter-list" class="row g-3" onsubmit="return false">
        <div class="col-12 col-md-6">
            <label class="form-label" for="modalFEmployeeName">Employee Name</label>
            <select
            id="f-employee-name"
            name="FEmployeeName"
            class="form-select"
            aria-label="Default select example"
            >
            <option></option>
            </select>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserFirstName">ID Number</label>
            <input
            type="text"
            id="f-id-number"
            name="FIdNumber"
            class="form-control"
            placeholder="16-0000"
            />
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditUserLastName">Transaction Code</label>
            <input
            type="text"
            id="f-transaction-code"
            name="FTransactionCode"
            class="form-control"
            placeholder="23-00-00000"
            />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" for="modalEditTaxID">Date Travel</label>
            <input type="text" class="form-control" name="FDateTravel" placeholder="DD-MM-YYYY" id="f-dateField" autocomplete="off"/>
        </div>


        <div class="col-12 col-md-6">
            <label class="form-label" >Incoming In</label>
            <input
            type="date"
            id="f-incoming-in"
            name="FIncomingIn"
            class="form-control"
            />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" >Slashed out</label>
            <input
            type="date"
            id="f-slashed-out"
            name="FSLashedOut"
            class="form-control"
            />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Original Amount</label>
            <div class="input-group">
            <span class="input-group-text">₱</span>
            <input
                type="number"
                id="f-original-amount"
                name="FOriginalAmount"
                class="form-control phone-number-mask"
                placeholder="0.00"
            />
            </div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label">Final Amount</label>
            <div class="input-group">
            <span class="input-group-text">₱</span>
            <input
                type="number"
                id="f-final-amount"
                name="FFinalAmount"
                class="form-control phone-number-mask"
                placeholder="0.00"
            />
            </div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" for="modalAccountNumber">Account number</label>
            <input
            type="text"
            id="f-account-number"
            name="FAccountNumber"
            class="form-control"
            placeholder="23-00-00000"
            />
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label" for="modalFEmployeeName">Incoming by</label>
            <select
            id="f-incoming-by"
            name="FIncomingBy"
            class="form-select"
            aria-label="Default select example"
            >
                <option></option>
                <option value="1">Reymark N. Valdehueza</option>
                <option value="2">Marwen A. Valeroso</option>
                <option value="3">Suspended</option>
            </select>
        </div>
            <input
            type="text"
            id="f-first-name"
            name="FFirstName"
            class="form-control"
            placeholder="Firstname"
            />

            <input
            type="text"
            id="f-middle-name"
            name="FMiddleName"
            class="form-control"
            placeholder="Middle"
            />

            <input
            type="text"
            id="f-last-name"
            name="FLastName"
            class="form-control"
            placeholder="Lastname"
            />
    


        <div class="col-12 text-center">
            <button type="button" id="search-advance-filter" class="btn btn-primary me-sm-3 me-1">Search</button>
            <button
            type="reset"
            class="btn btn-label-secondary"
            data-bs-dismiss="modal"
            aria-label="Close"
            >
            Cancel
            </button>
        </div>
        </form>
    </div>
    </div>
</div>
</div>
<!--/ Edit User Modal -->

      
<!-- Modal to add new record -->
<div class="offcanvas offcanvas-end" id="add-new-record">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="exampleModalLabel"><p class="title-name">Add Record</p></h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body flex-grow-1">
        <form class="add-new-record pt-0 row g-2" id="item-form">
            <input type="hidden" id="item-id" name="ItemID" />
            <div class="col-sm-12">
                <label class="form-label" for="employee-name">Employee Name</label>
                <select id="employee-name" name="EmployeeName" class="form-select employee" data-allow-clear="true">
                    <option></option>
                </select>
            </div>

            <div class="col-sm-12">
                <div class="form-group">
                    <label class="form-label" for="original-amount">Amount</label>
                    <input id="original-amount" name="OriginalAmount" class="form-control amount"type="number"placeholder="0.00"/>
                </div>
            </div>

            <div class="col-sm-12">
                <div class="col-md-12 mb-2">
                  <label for="flatpickr-multi" class="form-label">Date Travel</label>
                  <input type="text" class="form-control" name="DateTravel" placeholder="DD-MM-YYYY" id="dateField" autocomplete="off"/>
                </div>
            </div>

            <div class="col-sm-12">
                <div class="col-md-12 mb-2">
                  <label for="flatpickr-multi" class="form-label">Date Travel <small>(Range)</small></label>
                  <input
                  type="text"
                  class="form-control rangeTravel"
                  name="RangeTravel"
                  placeholder="YYYY-MM-DD to YYYY-MM-DD"
                  id="flatpickr-range"
                />
                </div>
            </div>

            <div class="col-sm-12">
                <div class="form-group">
                    <label class="form-label" for="remarks">Remarks</label>
                    <div class="input-group input-group-merge">
                        <textarea class="form-control dt-sales-remarks" placeholder="Enter remarks (optional)" rows="6" id="remarks" name="Remarks"></textarea>
                        <span class="input-group-text">
                          <i class="ti ti-microphone cursor-pointer text-to-speech-toggle"></i>
                        </span>
                       
                    </div>
                </div>
            </div>
            
            <div class="col-sm-12 mt-4">
                <button name="submitButton" class="btn btn-primary data-submit me-sm-3 me-1 additional-record">Submit</button>
                <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
            <input id="id-number" name="IdNumber" class="form-control idn" type="hidden" placeholder="16-0000"/>
            <input id="acct-number" name="AccountNumber" class="form-control accn" type="hidden" placeholder="000000"/>
            <input id="emp-name" name="EmpName" class="form-control accn" type="hidden" placeholder="nane"/>
            <input id="emp-middle" name="EmpMiddle" class="form-control accn" type="hidden" placeholder="middle"/>
            <input id="emp-lastname" name="EmpLastname" class="form-control accn" type="hidden" placeholder="lastname"/>
            <input id="hdate-travel" name="HDateTravel" class="form-control accn" type="hidden" placeholder="Date Travel"/>
        </form>
    </div>
</div>

{% endblock %} {% block footer_scripts %}
<script>
    let clicked_id = 0;
    let status_val =0;
    let formattedDates = ''

    $(document).ready(function () {
        employeelist();
        var dateField = $('#dateField').flatpickr({
            mode: 'multiple',
            allowInput: true,
            dateFormat: 'd-m-Y',
            locale: {
                'firstDayOfWeek': 1 // start week on Monday
            },
        });
        var fdateField = $('#f-dateField').flatpickr({
            mode: 'multiple',
            allowInput: true,
            dateFormat: 'd-m-Y',
            locale: {
                'firstDayOfWeek': 1 // start week on Monday
            },
        });

        $("#dateField").on("change", function() {
            if(DateTravel.val()){
                $(".rangeTravel").prop("disabled", true);
            }
            else{
                $(".rangeTravel").prop("disabled", false);
            } 
          });

        $(".rangeTravel").on("change", function() {
          
            if(RangeTravel.val()){
                $("#dateField").prop("disabled", true);
            }
            else{
                $("#dateField").prop("disabled", false);
            } 
          });
        
        const table = $('#tbl-items')
        const ItemFormValidation = document.getElementById('item-form'),
            AdvancedFilter = document.getElementById('advanced-filter-list'),
            EmployeeName = jQuery(document.querySelector('[name="EmployeeName"]')),
            FEmployeeName = jQuery(document.querySelector('[name="FEmployeeName"]')),
            FIdNumber= jQuery(document.querySelector('[name="FIdNumber"]')),
            FTransactionCode= jQuery(document.querySelector('[name="FTransactionCode"]')),
            FDateTravel= jQuery(document.querySelector('[name="FDateTravel"]')),
            FIncomingIn= jQuery(document.querySelector('[name="FIncomingIn"]')),
            FSLashedOut= jQuery(document.querySelector('[name="FSLashedOut"]')),
            FOriginalAmount= jQuery(document.querySelector('[name="FOriginalAmount"]')),
            FFinalAmount= jQuery(document.querySelector('[name="FFinalAmount"]')),
            FAccountNumber= jQuery(document.querySelector('[name="FAccountNumber"]')),
            FIncomingBy= jQuery(document.querySelector('[name="FIncomingBy"]')),
            FFirstName= jQuery(document.querySelector('[name="FFirstName"]')),
            FMiddleName= jQuery(document.querySelector('[name="FMiddleName"]')),
            FLastName= jQuery(document.querySelector('[name="FLastName"]')),

            OriginalAmount = jQuery(document.querySelector('[name="OriginalAmount"]')),
            DateTravel = jQuery(document.querySelector('[name="DateTravel"]')),
            HDateTravel = jQuery(document.querySelector('[name="HDateTravel"]')),
            RangeTravel = jQuery(document.querySelector('[name="RangeTravel"]')),
            IdNumber = jQuery(document.querySelector('[name="IdNumber"]')),
            AccountNumber = jQuery(document.querySelector('[name="AccountNumber"]')),
            EmpName = jQuery(document.querySelector('[name="EmpName"]')),
            EmpMiddle = jQuery(document.querySelector('[name="EmpMiddle"]')),
            EmpLastname = jQuery(document.querySelector('[name="EmpLastname"]')),
            Remarks = jQuery(document.querySelector('[name="Remarks"]')),
            offCanvasElement = document.querySelector('#add-new-record'),
            search_advance_filter = $('#search-advance-filter')
        const offCanvasEl = new bootstrap.Offcanvas(offCanvasElement)
        const toast_options = (toastr.options = {
            maxOpened: 1,
            autoDismiss: true,
            closeButton: true,
            newestOnTop: true,
            progressBar: true,
            positionClass: 'toast-top-right',
            rtl: isRtl,
      });
        let ItemID = $('#item-id')

        let dataTable = table.DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'item-load' %}",
                data: function (d) {
                    d.FIdNumber = FIdNumber.val()
                    d.FTransactionCode = FTransactionCode.val()
                    d.FDateTravel = FDateTravel.val()
                    d.FIncomingIn = FIncomingIn.val()
                    d.FSLashedOut = FSLashedOut.val()
                    d.FOriginalAmount = FOriginalAmount.val()
                    d.FFinalAmount = FFinalAmount.val()
                    d.FAccountNumber = FAccountNumber.val()
                    d.FIncomingBy = FIncomingBy.val()
                    d.FFirstName = FFirstName.val()
                    d.FMiddleName = FMiddleName.val()
                    d.FLastName = FLastName.val()
                },
            },
            columns: [
                {
                    data: 'id', status: 'status',
                    orderable: false, 
                    render: function (data, type, row) {
                        var status = row.status; // Access the 'status' value from the 'row' object

                        if (status == 3) {
                            return '<input type="checkbox" disabled="disabled">';
                        } else {
                            // Render a checkbox for each row with the item ID as its value
                            return '<input type="checkbox" class="checkbox-items" value="' + data + '">';
                        }

                    }
                },
                { data: 'code' },
                { data: 'id_no' },
                { data: 'name' },
                { data: 'original_amount'},
                { data: 'final_amount'},
                { data: 'date_travel'},
                { data: 'status' },
                { data: 'incoming_in' },
                { data: 'slashed_out' },
                { data: 'remarks' },
                { data: 'user_id' },
                { data: 'id' },

            ],
            columnDefs: [
                {
                    targets: 1,
                    render: function(data) {
                        return '<span class="badge bg-label-primary">' + data + '</span>';
                    
                    },
                },
                {
                    targets: 2,
                    render: function(data) {
                        if (data){
                            return '<span class="badge bg-label-primary">' + data + '</span>';
                        }
                        else {
                            return ''
                        }
                    },
                },
                {
                    targets: 4,
                    render: function(data) {
                        var floatValue = parseFloat(data);
                        if (floatValue !== 0) {
                            var convertedValue = floatValue.toFixed(2);
                            return convertedValue;
                        } else {
                            return "";
                        }
                    },
                },
                {
                    targets: 5,
                    render: function(data) {
                        var floatValue = parseFloat(data);
                        if (floatValue !== 0) {
                            var convertedValue = floatValue.toFixed(2);
                            return convertedValue;
                        } else {
                            return "";
                        }
                    },
                },
                {
                    targets: 6,
                    render: function(data) {
                        var splitValues = data.split(',');  // Split data by comma
                        var result = '';
                        
                        splitValues.forEach(function(value, index) {
                            if (index !== 0) {
                                result += '  '; // Add a space before adding subsequent values
                            }
                            var dateParts = value.split('-');
                            var monthNames = ["Jan.", "Feb.", "Mar.", "Apr.", "May", "Jun.", "Jul.", "Aug.", "Sep.", "Oct.", "Nov.", "Dec."];
                            var formattedDate = monthNames[parseInt(dateParts[1], 10) - 1] + ' ' + parseInt(dateParts[0], 10) + ', ' + dateParts[2];
                            
                            result += '<span class="badge bg-label-primary">' + formattedDate + '</span>';
                        });
                        
                        return result;
                    },
                },

                
                {
                  targets: 7,
                  render: function (data) {
                      if (data==1){
                        return '<span class="badge bg-label-warning">Pending</span>'
                      }
                      else if(data==2){
                        return '<span class="badge bg-label-warning">For checking</span>'
                      }
                      else if(data==3){
                        return '<span class="badge bg-label-danger">Returned</span>'
                      }
                      else{
                        return '<span class="badge bg-label-success">For payroll</span>'
                      }

                  },
                },
                {
                    targets: -5,
                    render: function (data) {
                        return (data == null) ? '' : moment(data).format('LLL');
                    },
                },
                {
                    targets: -4,
                    render: function (data) {
                        return (data == null) ? '' : moment(data).format('LLL');
                    },
                },
                {
                    targets: -2,
                    render: function (data) {
                        return data
                    },
                },
                {
                  targets: -1,
                  title: 'Action',
                  orderable: false,
                  searchable: false,
                  render: function (data) {
                      return (
                          '<a href="javascript:;" data-id="' + data + '" class="item-edit text-body"><i class="text-primary ti ti-pencil"></i></a>'
                      )
                  },
              },
            ],
            dom: '<"card-header flex-column flex-md-row"<"head-label text-center"><"dt-action-buttons text-end pt-3 pt-md-0"B>><"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-center justify-content-md-end"f>>t<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>',
            buttons: [
                {
                    className: 'btn btn-label-primary me-2',
                    text: '<i class="ti ti-file-search me-sm-1"></i> <span class="d-none d-sm-inline-block">Advance Filter</span>',
                    action: function () {
                        const $selectElement = $('#f-employee-name');
                        fetchEmployee($selectElement);
                        $("#advance-filter").modal("show");
                    }
    
                },
                {
                    className: 'btn btn-label-primary me-2',
                    text: '<i class="ti ti-file-export me-sm-1"></i> <span class="d-none d-sm-inline-block">Date Out</span>',
                    action: function () {
                        // Get the IDs of checked items
                        var selectedItems = [];
                        $('#tbl-items tbody input[type="checkbox"]:checked').each(function () {
                            selectedItems.push($(this).val());
                        });

                        if(selectedItems.length ===0){
                            toastr.error('Select item first', 'Invalid', toast_options);
                        }
                        else{
                            incoming_out(selectedItems);
                        }
                    }
                },


                {
                    text: '<i class="ti ti-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">Add New Record</span>',
                    className: 'create-new btn btn-primary',
                },
            ],
            drawCallback: function (settings) {
                $('.item-edit').on('click', function () {
                    let id = $(this).data('id')
                    $('.title-name').text('Update TEV Record')
                    $.ajax({
                        type: 'GET',
                        url: "{% url 'item-edit' %}?id=" + id,
                        dataType: 'json',
                    }).done(function (data) {
                        if (data.length > 0) {
                            const $selectElement1 = $('#employee-name');
                            fetchEmployee($selectElement1);
                            let fields = data[0].fields
                            let pk = data[0].pk
                            let employee_name = $('#employee-name');
                            let floatvalue = parseFloat(fields.final_amount);
                            let convertedAmount = 0;
                            let date_travel = fields.date_travel;
                            formattedDates = date_travel.split(',').map(date => date.trim()).join(', ');
                            status_val = fields.status;
                            let fullname = fields.first_name + " " + fields.middle_name + " " + fields.last_name
                            if(status_val ===3){
                                EmployeeName.val(fullname).trigger('change').prop("disabled", true);
                                convertedAmount = floatvalue.toFixed(2);
                                OriginalAmount.prop("disabled", true);
                                DateTravel.prop("disabled", true);
                                RangeTravel.prop("disabled", true);
                            }
                            else{
                                EmployeeName.val(fullname).trigger('change').prop("disabled", false);
                                let original_amt = parseFloat(fields.original_amount)
                                convertedAmount = original_amt.toFixed(2);
                                OriginalAmount.prop("disabled", false);
                                DateTravel.prop("disabled", false);
                                RangeTravel.prop("disabled", false);
                            }

                            if (DateTravel){
                                RangeTravel.prop("disabled", true);
                            }
                            else if(RangeTravel){
                                DateTravel.prop("disabled", true);
                            }

                            
                            HDateTravel.val(formattedDates)
                            OriginalAmount.val(convertedAmount);
                            Remarks.val(fields.remarks);
                            DateTravel.val(formattedDates);
                            ItemID.val(pk);
                            updateSelectedDates();
                            offCanvasEl.show()
                        }
                    })
                }),

                $('#tbl-items tbody input[type="checkbox"]').change(function () {
                    // Do something when a checkbox in the table body is changed...
                });

                $('#check-all').change(function () {
                    // Get the checked state of the "check-all" checkbox
                    var isChecked = $(this).is(':checked');
        
                    // Set the checked state of all checkboxes in the table body
                    $('#tbl-items tbody input[type="checkbox"][class="checkbox-items"]').prop('checked', isChecked);
                });

                $('.item-details').on('click', function () {
                    clicked_id = $(this).data('id');
                    $.ajax({
                        type: 'POST',
                        url: "{% url 'tev-details' %}",
                        data:{
                            tev_id: clicked_id
                        }
                    }).done(function (data) {
                        let value = data.data.remarks;
                        let final_amount = data.data.final_amount;
                        let floatvalue = parseFloat(final_amount);
                        let convertedAmount = floatvalue.toFixed(2);
                        if (convertedAmount === "0.00") {convertedAmount =""} 
                        $("#final_amount").val(convertedAmount);
                        $("#correctness_remarks").val(value);
                    })
                });
            },
        })
        $('div.head-label').html('<h5 class="card-title mb-0">Items</h5>')

        const newRecord = document.querySelector('.create-new')
            if (newRecord) {
                newRecord.addEventListener('click', function () {


                    const $selectElement1 = $('#employee-name');
                    fetchEmployee($selectElement1);


                    ItemID.val(0)
                    
                    $("#dateField").prop("disabled", false);
                    $(".rangeTravel").prop("disabled", false);
                    $('.title-name').text('Add Tev Record')
                    EmployeeName.val('').trigger('change').prop("disabled", false);
                    $('.form-control').val('');
                    updateSelectedDates();
                    offCanvasEl.show()
                })
            }

        // Form validation for Add new record
        const fv = FormValidation.formValidation(ItemFormValidation, {
            fields: {
                EmployeeName: {
                    validators: {
                        notEmpty: {
                            message: 'Please Select Employee',
                        },
                    },
                },
                OriginalAmount: {
                    validators: {
                        notEmpty: {
                            message: 'Please Select Amount',
                        },
                    },
                },

            },
            plugins: {
                trigger: new FormValidation.plugins.Trigger(),
                bootstrap5: new FormValidation.plugins.Bootstrap5(),
                submitButton: new FormValidation.plugins.SubmitButton(),
                autoFocus: new FormValidation.plugins.AutoFocus(),
            },
            init: (instance) => {
                instance.on('plugins.message.placed', function (e) {
                    if (e.element.parentElement.classList.contains('input-group')) {
                        e.element.parentElement.insertAdjacentElement('afterend', e.messageElement)
                    }
                })
            },
        }).on('core.form.valid', function () {
            if (DateTravel.val() && RangeTravel.val() ){
                toastr.error('Duplicate Travel Date : Select only one', 'Invalid', toast_options);
            }
            else if (!DateTravel.val() && !RangeTravel.val()){
                toastr.error('Please: Select one Date Travel', 'Invalid', toast_options);
            }
            else {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, save it!',
                    customClass: {
                        confirmButton: 'btn btn-primary me-3',
                        cancelButton: 'btn btn-label-secondary',
                    },
                    buttonsStyling: false,
                }).then(function (result) {
                    if (result.value) {
                        var form_data = $('#item-form').serialize()
                        let post_url = (status_val == 3)? "{% url 'item-returned' %}": (ItemID.val() !== '0')? "{% url 'item-update' %}": "{% url 'item-add' %}";
                    
                        var form_data = $('#item-form').serialize()
                        $.ajax({
                            type: 'POST',
                            url: post_url,
                            data: form_data,
                        }).done(function (data) {
                            if (data.data == 'success') {
                                dateField.clear();

                                let code = data.g_code;
                                if (code){
                                    Swal.fire({
                                        title: '<strong>TEV Code <u>'+data.g_code+'</u></strong>',
                                        icon: 'info',
                                        html:
                                        'Successfully <b>Save!</b>',
                                        showCloseButton: true,
                                        showCancelButton: false,
                                        focusConfirm: false,
                                        confirmButtonText: '<i class="ti ti-thumb-up"></i> Done!',
                                        confirmButtonAriaLabel: 'Thumbs up, great!',
                                        customClass: {
                                        confirmButton: 'btn btn-primary me-3'
                                        },
                                        buttonsStyling: false
                                    });

                                }
                                else{
                                    offCanvasEl.hide()
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Update Successfully!',
                                        html:
                                        'Successfully <b>Save!</b>',
                                        customClass: {
                                            confirmButton: 'btn btn-success',
                                        },
                                    })
                                }
                                EmployeeName.val("").trigger('change');
                                OriginalAmount.val("");
                                DateTravel.val("")
                                Remarks.val("");
                                RangeTravel.val("")
                                $("#dateField").prop("disabled", false);
                                $(".rangeTravel").prop("disabled", false);

                                dataTable.ajax.reload();
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error saving!',
                                    html:"Duplicate Travel <br><b>"+data.message+"</b>",
                                    customClass: {
                                        confirmButton: 'btn btn-success',
                                    },
                                })
                            }
                        })
                    }
                });
            }
        });



        
        // Form validation for Add new record
        const adv = FormValidation.formValidation(AdvancedFilter, {
            fields: {
            },
            plugins: {
                trigger: new FormValidation.plugins.Trigger(),
                bootstrap5: new FormValidation.plugins.Bootstrap5(),
                submitButton: new FormValidation.plugins.SubmitButton(),
                autoFocus: new FormValidation.plugins.AutoFocus(),
            },
            init: (instance) => {
                instance.on('plugins.message.placed', function (e) {
                    if (e.element.parentElement.classList.contains('input-group')) {
                        e.element.parentElement.insertAdjacentElement('afterend', e.messageElement)
                    }
                })
            },
        }).on('core.form.valid', function () {
            var form_data = $('#advanced-filter-list').serialize();
            var form_data = $('#item-form').serialize()
            $.ajax({
                type: 'POST',
                url: "{% url 'search-list' %}",
                data: form_data,
            }).done(function (data) {
                if (data.data == 'success') {

                } else {

                }
            });

        });
        
        

        function fetchEmployee($selectElement) {
            $selectElement.empty();
            const employees = JSON.parse(localStorage.getItem('employees'));
            if (employees) {
                $.each(employees, function (index, employee) {
                    const optionText = `${employee.firstName} ${employee.middleInitial} ${employee.lastName}`;
                    const $option = $('<option>', {
                        value: optionText,
                        text: optionText,
                        id: employee.idNumber
                    });
                    $selectElement.append($option);
                });
            } else {
                console.log("No employee data found in local storage.");
            }
        }

        function updateSelectedDates() {
            var inputFieldValue = $('#dateField').val();
            if (inputFieldValue) {
                var inputDates = inputFieldValue.split(', ');
                var selectedDates = inputDates.map(function(dateString) {
                    return dateString; // No need to parse, use as is
                });
                dateField.setDate(selectedDates);
            } else {
                dateField.clear();
            }
        }

        function employeelist(){
            $.ajax({
                type: 'GET',
                url: "{% url 'receive-api' %}",
                dataType: 'json',
            }).done(function (data) {
                let fields = data.data;
            
                let employees = [];
            
                $.each(fields, function (index, employee) {
                    let firstName = employee.first_name;
                    let middleName = employee.middle_name;
                    let middleInitial = middleName.charAt(0);
                    let lastName = employee.last_name;
                    let idNumber = employee.id_number;
                    let accNumber = employee.account_number;
            
                    let employeeObj = {
                        firstName: firstName,
                        middleInitial: middleInitial,
                        lastName: lastName,
                        idNumber: idNumber,
                        accNumber: accNumber
                    };
                    employees.push(employeeObj);
                });
                localStorage.setItem('employees', JSON.stringify(employees));
            });
            
        }
       // $('#dateField').flatpickr({
            //mode: 'multiple',
           // allowInput: true,
           // dateFormat: 'd-m-Y',
           // locale: {
                //'firstDayOfWeek': 1 // start week on Monday
          //  },
      //  });
        function incoming_out(selected_items){
            Swal.fire({
                title: 'Mark as Out?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, mark as out!',
                customClass: {
                    confirmButton: 'btn btn-primary me-3',
                    cancelButton: 'btn btn-label-secondary',
                },
                buttonsStyling: false,
            }).then(function (result) {
                if (result.value) {
                    let post_url = ItemID.val() != '0' ? "{% url 'item-update' %}" : "{% url 'item-add' %}"
       
                    $.ajax({
                        type: 'POST',
                        url: "{% url 'out-pending-tev' %}",
                        data:{
                            out_list: selected_items
                        }
                    }).done(function (data) {
                        if (data.data == 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'Successfully save!',
                                text: 'Item has been added.',
                                customClass: {
                                    confirmButton: 'btn btn-success',
                                },
                            })

                            dateField.clear();
                            dataTable.ajax.reload()
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error saving!',
                                text: data.message,
                                customClass: {
                                    confirmButton: 'btn btn-success',
                                },
                            })
                        }
                    })
                }
            })

        }



        search_advance_filter.on('click', function () {
            alert("daaaa");
            dataTable.ajax.reload();
        })


        $('#approved').click(function() {
            let final_amount = $("#final_amount").val().trim();
            let correctness_remarks = $("#correctness_remarks").val().trim();
            let status = 4; 
              if (final_amount === "") {  
                $("#amount_error").text("Please enter Amount");
                $("#remarks_error").text("");
                $(".input-group").addClass("has-error");
                event.preventDefault();
              } else {
                $("#amount_error").text("");
                $("#remarks_error").text("");
                $(".input-group").removeClass("has-error");
                tev_details(final_amount,correctness_remarks,status,clicked_id);
              }
          });



          $('#employee-name').change(function() {
            var selectedOption = $(this).find('option:selected');
            var optionText = selectedOption.attr('id');
            if (optionText) {
                const employees = JSON.parse(localStorage.getItem('employees'));
                if (employees) {
                    const selectedEmployeeId = selectedOption.attr('id');
                    const selectedEmployee = employees.find(employee => employee.idNumber === selectedEmployeeId);
      
                    
                    if (selectedEmployee) {
                        $('#id-number').val(selectedEmployee.idNumber);
                        $('#acct-number').val(selectedEmployee.accNumber);
                        $('#emp-name').val(selectedEmployee.firstName);
                        $('#emp-middle').val(selectedEmployee.middleInitial);
                        $('#emp-lastname').val(selectedEmployee.lastName);
                    }
                } else {
                    console.log("No employee data found in local storage.");
                }
            }
        });

        $('#f-employee-name').change(function() {
            var selectedOption = $(this).find('option:selected');
            var optionText = selectedOption.attr('id');
            if (optionText) {
                const employees = JSON.parse(localStorage.getItem('employees'));
                if (employees) {
                    const selectedEmployeeId = selectedOption.attr('id');
                    const selectedEmployee = employees.find(employee => employee.idNumber === selectedEmployeeId);
      
                    
                    if (selectedEmployee) {
                        $('#f-first-name').val(selectedEmployee.firstName);
                        $('#f-middle-name').val(selectedEmployee.middleInitial);
                        $('#f-last-name').val(selectedEmployee.lastName);
                    }
                } else {
                    console.log("No employee data found in local storage.");
                }
            }
        });
        


          
          $('#returned').click(function() {
            let final_amount = $("#final_amount").val().trim();
            let correctness_remarks = $("#correctness_remarks").val().trim();
            let status = 3;
              if (correctness_remarks === "") {
                $("#amount_error").text("");
                $("#remarks_error").text("Please enter Remarks for returned.");
                $(".input-group").addClass("has-error");
                event.preventDefault();
              } else {
                $("#remarks_error").text("");
                $(".input-group").removeClass("has-error");
                tev_details(final_amount,correctness_remarks,status,clicked_id);
              }
              
            });

        function tev_details(amount,remarks,status,emp_id){
            $.ajax({
                type: "POST",
                url: "{% url 'add-tev-details' %}",
                data:{
                    final_amount: amount,
                    remarks: remarks,
                    status : status,
                    transaction_id : emp_id
                }
                }).done(function(data){
                if (data.data == 'success') {
                    $('#tevDetails').modal('hide');
                    toastr.success('Successfully save', 'Success', toast_options);
                    offCanvasEl.hide()
                    dataTable.ajax.reload()
                } else {
                    toastr.danger('Data not saved', 'Danger', toast_options);
                }
            });
            }



        //select 2
        if (EmployeeName.length) {
            EmployeeName.wrap('<div class="position-relative"></div>')
            EmployeeName.select2({
                placeholder: 'Choose employee',
                dropdownParent: EmployeeName.parent(),
                allowClear: true,
            })
        }

        if (FEmployeeName.length) {
            FEmployeeName.wrap('<div class="position-relative"></div>')
            FEmployeeName.select2({
                placeholder: 'Choose employee',
                dropdownParent: FEmployeeName.parent(),
                allowClear: true,
            })
        }

        if (FIncomingBy.length) {
            FIncomingBy.wrap('<div class="position-relative"></div>')
            FIncomingBy.select2({
                placeholder: 'Choose Incoming',
                dropdownParent: FIncomingBy.parent(),
                allowClear: true,
            })
        }
        
        //end select2

    })
</script>
{% endblock footer_scripts %}
