{% extends 'index.html' %} {% block content %} {% load staticfiles %}
<style>
  #form-message {
    display: none;
  }
</style>
<!-- Content -->

<div class="container-fluid flex-grow-1 container-p-y">

              <!-- Content -->

              <div class="container-xxl flex-grow-1 container-p-y">
                <div class="app-chat card overflow-hidden">
                  <div class="row g-0">
                    <!-- Sidebar Left -->
                    <div class="col app-chat-sidebar-left app-sidebar overflow-hidden" id="app-chat-sidebar-left">
                      <div
                        class="chat-sidebar-left-user sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-4 pt-5"
                      >
                        <div class="avatar avatar-xl avatar-online">
                          <img src="{{image_path}}" alt="Avatar" class="rounded-circle" />
                        </div>
                        <h5 class="mt-2 mb-0">{{ request.user.first_name }} {{ request.user.last_name }}</h5>
                        <small>Admin</small>
                        <i
                          class="ti ti-x ti-sm cursor-pointer close-sidebar"
                          data-bs-toggle="sidebar"
                          data-overlay
                          data-target="#app-chat-sidebar-left"
                        ></i>
                      </div>
        
                    </div>
                    <!-- /Sidebar Left-->
  
                    <!-- Chat & Contacts -->
                    <div
                      class="col app-chat-contacts app-sidebar flex-grow-0 overflow-hidden border-end"
                      id="app-chat-contacts"
                    >
                      <div class="sidebar-header">
                        <div class="d-flex align-items-center me-3 me-lg-0">
                          <div
                            class="flex-shrink-0 avatar avatar-online me-3"
                            data-bs-toggle="sidebar"
                            data-overlay="app-overlay-ex"
                            data-target="#app-chat-sidebar-left"
                          >
                            <img
                              class="user-avatar rounded-circle cursor-pointer"
                              src="{{image_path}}"
                              alt="Avatar"
                            />
                          </div>
                          <div class="flex-grow-1 input-group input-group-merge rounded-pill">
                            <span class="input-group-text" id="basic-addon-search31"><i class="ti ti-search"></i></span>
                            <input
                              type="text"
                              class="form-control chat-search-input"
                              placeholder="Search..."
                              aria-label="Search..."
                              aria-describedby="basic-addon-search31"
                            />
                          </div>
                        </div>
                        <i
                          class="ti ti-x cursor-pointer d-lg-none d-block position-absolute mt-2 me-1 top-0 end-0"
                          data-overlay
                          data-bs-toggle="sidebar"
                          data-target="#app-chat-contacts"
                        ></i>
                      </div>
                      <hr class="container-m-nx m-0" />
                      <div class="sidebar-body">
                        <div class="chat-contact-list-item-title">
                          <h5 class="text-primary mb-0 px-4 pt-3 pb-2">Chats</h5>
                        </div>
                        <!-- Chats -->
                        <ul class="list-unstyled chat-contact-list" id="chat-list">
                          <li class="chat-contact-list-item chat-list-item-0 d-none">
                            <h6 class="text-muted mb-0">No Chats Found</h6>
                          </li>

                          {% for row in combined_data %}
                            <li class="chat-contact-list-item" data-id="{{ row.id }}">
                              <a class="d-flex align-items-center">
                                <div class="flex-shrink-0 avatar avatar-online">
                                  <img src="{{row.image_path}}" alt="Avatar" class="rounded-circle" />
                                </div>
                                <div class="chat-contact-info flex-grow-1 ms-2">
                                  <h6 class="chat-contact-name text-truncate m-0">{{row.first_name}} {{row.last_name}}</h6>
                                  <p class="chat-contact-status text-muted text-truncate mb-0">
                                    Refer friends. Get rewards.
                                  </p>
                                </div>
                                <small class="text-muted mb-auto">5 Minutes</small>
                              </a>
                            </li>
                          {% endfor %}
                        </ul>

                      </div>
                    </div>
                    <!-- /Chat contacts -->
  
                    <!-- Chat History -->
                    <div class="col app-chat-history bg-body">
                      <div class="chat-history-wrapper">
                        <div class="chat-history-header border-bottom">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex overflow-hidden align-items-center">
                              <i
                                class="ti ti-menu-2 ti-sm cursor-pointer d-lg-none d-block me-2"
                                data-bs-toggle="sidebar"
                                data-overlay
                                data-target="#app-chat-contacts"
                              ></i>
                              <div class="flex-shrink-0 avatar">
                                <img
                                  src="{% static 'assets/img/avatars/avatar_custom.png' %}"
                                  alt="Avatar"
                                  class="rounded-circle"
                                  data-bs-toggle="sidebar"
                                  data-overlay
                                  data-target="#app-chat-sidebar-right"
                                  id="user-profile-img"
                                />
                              </div>
                              <div class="chat-contact-info flex-grow-1 ms-2">
                                <h6 class="m-0 txt-fullname">Welcome to Chat Bot</h6>
                                <small class="user-status text-muted spn-position">Messaging</small>
                              </div>
                            </div>
                            <div class="d-flex align-items-center">
                              <i class="ti ti-phone-call cursor-pointer d-sm-block d-none me-3"></i>
                              <i class="ti ti-video cursor-pointer d-sm-block d-none me-3"></i>
                              <i class="ti ti-search cursor-pointer d-sm-block d-none me-3"></i>
                              <div class="dropdown">
                                <i
                                  class="ti ti-dots-vertical cursor-pointer"
                                  id="chat-header-actions"
                                  data-bs-toggle="dropdown"
                                  aria-haspopup="true"
                                  aria-expanded="false"
                                >
                                </i>
                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="chat-header-actions">
                                  <a class="dropdown-item" href="javascript:void(0);">View Contact</a>
                                  <a class="dropdown-item" href="javascript:void(0);">Mute Notifications</a>
                                  <a class="dropdown-item" href="javascript:void(0);">Block Contact</a>
                                  <a class="dropdown-item" href="javascript:void(0);">Clear Chat</a>
                                  <a class="dropdown-item" href="javascript:void(0);">Report</a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="chat-history-body bg-body">
                          <ul class="list-unstyled chat-history" id="chat-messages-container">

                          </ul>
                        </div>
                        <!-- Chat message form -->
                        <div class="chat-history-footer shadow-sm" id="form-message">
                          <form class="form-send-message-custom d-flex justify-content-between align-items-center">
                            <input
                              class="form-control message-input border-0 me-3 shadow-none"
                              placeholder="Type your message here"
                              id="my-message"
                              name="my-message"
                              autocomplete="off"
                            />
                            <div class="message-actions d-flex align-items-center">
                              <button class="btn btn-primary d-flex send-msg-btn" id="send-chat-btn">
                                <i class="ti ti-send me-md-1 me-0"></i>
                                <span class="align-middle d-md-inline-block d-none">Send</span>
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    <!-- /Chat History -->
  
                    <!-- Sidebar Right -->
                    <div class="col app-chat-sidebar-right app-sidebar overflow-hidden" id="app-chat-sidebar-right">
                      <div
                        class="sidebar-header d-flex flex-column justify-content-center align-items-center flex-wrap px-4 pt-5"
                      >
                        <div class="avatar avatar-xl avatar-online">
                          <img src="{% static 'assets/img/avatars/2.png' %}" alt="Avatar" class="rounded-circle" />
                        </div>
                        <h6 class="mt-2 mb-0">Felecia Rower</h6>
                        <span>NextJS Developer</span>
                        <i
                          class="ti ti-x ti-sm cursor-pointer close-sidebar d-block"
                          data-bs-toggle="sidebar"
                          data-overlay
                          data-target="#app-chat-sidebar-right"
                        ></i>
                      </div>
                      {% comment %} <div class="sidebar-body px-4 pb-4">
                        <div class="my-4">
                          <p class="text-muted text-uppercase">About</p>
                          <p class="mb-0 mt-3">
                            A Next. js developer is a software developer who uses the Next. js framework alongside ReactJS
                            to build web applications.
                          </p>
                        </div>
                        <div class="my-4">
                          <p class="text-muted text-uppercase">Personal Information</p>
                          <ul class="list-unstyled d-grid gap-2 mt-3">
                            <li class="d-flex align-items-center">
                              <i class="ti ti-mail"></i>
                              <span class="align-middle ms-2">josephGreen@email.com</span>
                            </li>
                            <li class="d-flex align-items-center">
                              <i class="ti ti-phone-call"></i>
                              <span class="align-middle ms-2">+1(123) 456 - 7890</span>
                            </li>
                            <li class="d-flex align-items-center">
                              <i class="ti ti-clock"></i>
                              <span class="align-middle ms-2">Mon - Fri 10AM - 8PM</span>
                            </li>
                          </ul>
                        </div>
                        <div class="mt-4">
                          <p class="text-muted text-uppercase">Options</p>
                          <ul class="list-unstyled d-grid gap-2 mt-3">
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-badge"></i>
                              <span class="align-middle ms-2">Add Tag</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-star"></i>
                              <span class="align-middle ms-2">Important Contact</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-photo"></i>
                              <span class="align-middle ms-2">Shared Media</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-trash"></i>
                              <span class="align-middle ms-2">Delete Contact</span>
                            </li>
                            <li class="cursor-pointer d-flex align-items-center">
                              <i class="ti ti-ban"></i>
                              <span class="align-middle ms-2">Block Contact</span>
                            </li>
                          </ul>
                        </div>
                      </div> {% endcomment %}
                    </div>
                    <!-- /Sidebar Right -->
  
                    <div class="app-overlay"></div>
                  </div>
                </div>
              </div>
              <!-- / Content -->

</div>



{% endblock %} {% block footer_scripts %}
<script src="{% static 'assets/js/app-chat.js' %}"></script> 
<script>
  window.Helpers.initCustomOptionCheck();
  $(document).ready(function () {
      const websocketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const wsEndpoint = `ws://${window.location.host}/ws/notification/`;
      
      let socket = null;
      let staff_id = 0;
      const chatMessagesContainer = document.querySelector('#chat-messages-container');
      const ChatMessage = jQuery(document.querySelector('[name="my-message"]'));
      const formSendMessageCustom = document.querySelector('.form-send-message-custom');
      const messageInput = document.querySelector('.message-input');
      const chatHistoryBody = document.querySelector('.chat-history-body');
      const toast_options = (toastr.options = {
          maxOpened: 1,
          autoDismiss: true,
          closeButton: true,
          newestOnTop: true,
          progressBar: true,
          positionClass: 'toast-top-right',
          rtl: isRtl,
      });

      function openSocket(id) {
          socket = new WebSocket(wsEndpoint + id + '/');
          
          socket.onopen = (event) => {
              console.log("WebSocket connection opened!" + id);
          };

          socket.onclose = (event) => {
              console.log("WebSocket connection closed!");
          };

          socket.onerror = (error) => {
              console.error("WebSocket error: ", error);
          };

          socket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              console.log("Message received: ", data);
              // Handle received message
          };
      }

      function sendMessage() {
          if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(
                  JSON.stringify({
                      'message': ChatMessage.val(),
                      'room_name': 'rooms',
                      'sender': 'macky',
                  })
              );
          } else {
              console.log("WebSocket is not open. Ready state is: " + (socket ? socket.readyState : 'N/A'));
          }
      }

      $('.chat-contact-list-item').on('click', function() {
          $('#form-message').show();
          const id = $(this).data('id');
          staff_id = id;
          if (socket) {
              socket.close();
          }
          openSocket(id);

          $.ajax({
              type: 'POST',
              url: "{% url 'chat-data-staff' %}",
              data: {
                  auth_user_id: id
              },
              success: function(response) {
                  $('#chat-messages-container').empty();

                  console.log("testttttttttt");

                  
                  console.log(response);
                  // const data = response.data;
                  // const userData = data.combined_data[0];
                  // const user_id = userData.id;
                  // const login_id = userData.login_id;
                  // if (data.combined_data && data.combined_data.length > 0) {
                  //     $('.chat-contact-info .txt-fullname').text(userData.first_name + ' ' + userData.last_name);
                  //     $('.chat-contact-info .spn-position').text(userData.position);
                  //     $('#user-profile-img').attr('src', userData.image_path);
                  // }

                  // if (data.messages && data.messages.length > 0) {
                  //     data.messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                  //     data.messages.forEach(function(message) {
                  //         const messageClass = message.from_user === login_id ? 'chat-message-right' : 'chat-message';
                  //         const formattedDate = new Date(message.created_at).toLocaleString();
                  //         const messageHtml = `
                  //             <li class="chat-message ${messageClass}">
                  //                 <div class="d-flex overflow-hidden">
                  //                     ${messageClass === 'chat-message' ? `
                  //                     <div class="user-avatar flex-shrink-0 me-3">
                  //                         <div class="avatar avatar-sm">
                  //                             <img src="${userData.image_path}" alt="Avatar" class="rounded-circle" />
                  //                         </div>
                  //                     </div>` : ''}
                  //                     <div class="chat-message-wrapper flex-grow-1">
                  //                         <div class="chat-message-text">
                  //                             <p class="mb-0">${message.message}</p>
                  //                         </div>
                  //                         <div class="${messageClass === 'chat-message' ? 'text-muted' : 'text-end text-muted'} mt-1">
                  //                             ${messageClass === 'chat-message-right' ? '<i class="ti ti-checks ti-xs me-1 text-success"></i>' : ''}
                  //                             <small>${formattedDate}</small> 
                  //                         </div>
                  //                     </div>
                  //                     ${messageClass === 'chat-message-right' ? `
                  //                     <div class="user-avatar flex-shrink-0 ms-3">
                  //                         <div class="avatar avatar-sm">
                  //                             <img src="${userData.image_path_user}" alt="Avatar" class="rounded-circle" />
                  //                         </div>
                  //                     </div>` : ''}
                  //                 </div>
                  //             </li>
                  //         `;
                  //         $('#chat-messages-container').append(messageHtml);
                  //     });
                      scrollToBottom();
                  // }
              },
              error: function(xhr, status, error) {
                  console.error("Error fetching chat data: ", error);
              }
          });
      });

      $("#send-chat-btn").click(function() {  
          if (staff_id == 0) {
              toastr.error('Select User first', 'Invalid', toast_options);
          } else {
              sendMessage();
          }
      });

      $("#send_btn").click(function() { 
          const contact_no = $('#contact_no').val();
          const message = $('#sms_message').val();
          $.ajax({
              type: 'POST',
              url: "{% url 'send-sms' %}",
              data: {
                  contact: contact_no,
                  message: message        
              }
          }).done(function (data) {
              toastr.success('Sent successfully', 'Success', toast_options);
          });
      });

      formSendMessageCustom.addEventListener('submit', function(e) {
          e.preventDefault();
          const message = messageInput.value.trim();
          if (message) {
              console.log("Sending message: ", message);
              const li = document.createElement('li');
              li.className = 'chat-message chat-message-right';
              const messageHtml = `
                  <div class="d-flex overflow-hidden">
                      <div class="chat-message-wrapper flex-grow-1">
                          <div class="chat-message-text">
                              <p class="mb-0">${message}</p>
                          </div>
                          <div class="text-end text-muted mt-1">
                              <i class="ti ti-checks ti-xs me-1 text-success"></i>
                              <small>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                          </div>
                      </div>
                      <div class="user-avatar flex-shrink-0 ms-3">
                          <div class="avatar avatar-sm">
                              <img src="{{image_path}}" alt="Avatar" class="rounded-circle" />
                          </div>
                      </div>
                  </div>
              `;
              li.innerHTML = messageHtml;
              chatMessagesContainer.appendChild(li);
              messageInput.value = ''; // Clear the input field
              scrollToBottom(); // Ensure the chat scrolls to the bottom
          }
      });

      if (chatHistoryBody) {
          new PerfectScrollbar(chatHistoryBody, {
              wheelPropagation: false,
              suppressScrollX: true
          });
      }

      function scrollToBottom() {
          chatHistoryBody.scrollTo(0, chatHistoryBody.scrollHeight);
      }
  });
</script>



{% comment %} <script>
    window.Helpers.initCustomOptionCheck();
    $(document).ready(function () {
      const websocketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const wsEndpoint = `ws://${window.location.host}/ws/notification/`;
      

      // form-message

      let staff_id = 0;
      const chatMessagesContainer = document.querySelector('#chat-messages-container');
      const ChatMessage = jQuery(document.querySelector('[name="my-message"]'));
      const formSendMessageCustom = document.querySelector('.form-send-message-custom');
      const messageInput = document.querySelector('.message-input');
      const chatHistoryBody = document.querySelector('.chat-history-body');
      const toast_options = (toastr.options = {
          maxOpened: 1,
          autoDismiss: true,
          closeButton: true,
          newestOnTop: true,
          progressBar: true,
          positionClass: 'toast-top-right',
          rtl: isRtl,
      });
      $('.chat-contact-list-item').on('click', function() {
          $('#form-message').show();
          var id = $(this).data('id');
          staff_id = id;
          const socket = new WebSocket(wsEndpoint+id+'/');

          socket.onopen = (event) => {
            console.log("WebSocket connection opened!" + staff_id);
          };
      
          socket.onclose = (event) => {
              console.log("WebSocket connection closed!");
          };

          $.ajax({
            type: 'POST',
            url: "{% url 'chat-data-staff' %}",
            data: {
                auth_user_id: id
            },
            success: function(response) {

                $('#chat-messages-container').empty();
                var data = response.data;
                var userData = data.combined_data[0];
                var user_id = userData.id;
                var login_id = userData.login_id;
                if (data.combined_data && data.combined_data.length > 0) {
                  $('.chat-contact-info .txt-fullname').text(userData.first_name + ' ' + userData.last_name);
                  $('.chat-contact-info .spn-position').text(userData.position);
                  $('#user-profile-img').attr('src', userData.image_path);
                }

                if (data.messages && data.messages.length > 0) {
                  data.messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                  data.messages.forEach(function(message) {
                      var messageClass = message.from_user === login_id ? 'chat-message-right' : 'chat-message';
                      var formattedDate = new Date(message.created_at).toLocaleString();
                      var messageHtml = `
                          <li class="chat-message ${messageClass}">
                            <div class="d-flex overflow-hidden">
                              ${messageClass === 'chat-message' ? `
                              <div class="user-avatar flex-shrink-0 me-3">
                                <div class="avatar avatar-sm">
                                  <img src="${userData.image_path}" alt="Avatar" class="rounded-circle" />
                                </div>
                              </div>` : ''}
                              <div class="chat-message-wrapper flex-grow-1">
                                <div class="chat-message-text">
                                  <p class="mb-0">${message.message}</p>
                                </div>
                                <div class="${messageClass === 'chat-message' ? 'text-muted' : 'text-end text-muted'} mt-1">
                                  ${messageClass === 'chat-message-right' ? '<i class="ti ti-checks ti-xs me-1 text-success"></i>' : ''}
                                  <small>${formattedDate}</small> 
                                </div>
                              </div>
                              ${messageClass === 'chat-message-right' ? `
                              <div class="user-a  vatar flex-shrink-0 ms-3">
                                <div class="avatar avatar-sm">
                                  <img src="${userData.image_path_user}" alt="Avatar" class="rounded-circle" />
                                </div>
                              </div>` : ''}
                            </div>
                          </li>
                      `;

                      $('#chat-messages-container').append(messageHtml);
                  });
                  scrollToBottom();
                }
            },
            error: function(xhr, status, error) {
            }
          });
      });


      $("#send-chat-btn").click(function(){  
        console.log("testtt");
        console.log(wsEndpoint);
        const socket = new WebSocket(wsEndpoint+'rooms/');
        if(staff_id ==0){
          toastr.error('Select User first', 'Invalid', toast_options);
        }
        else{
          socket.onopen = (event) => {
            console.log("WebSocket connection openedssss!" + staff_id);
          };
          console.log(socket);
          console.log("chattdiaayy");

          socket.send(
            JSON.stringify({
                'message': ChatMessage.val(),
                'room_name': 'rooms',
                'sender': 'macky',
            })
          )
        }
      });


      $("#send_btn").click(function(){ 
          let contact_no =  $('#contact_no').val();
          let message =  $('#sms_message').val();
          $.ajax({
              type: 'POST',
              url: "{% url 'send-sms' %}",
              data:{
                  contact: contact_no,
                  message: message        
              }
            }).done(function (data) {
              toastr.success('Sent successfully', 'Success', toast_options);
          });
      });

      formSendMessageCustom.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
          console.log("Sending message: ", message);
          // Create a new list item for the message
          const li = document.createElement('li');
          li.className = 'chat-message chat-message-right';
    
          const messageHtml = `
            <div class="d-flex overflow-hidden">
              <div class="chat-message-wrapper flex-grow-1">
                <div class="chat-message-text">
                  <p class="mb-0">${message}</p>
                </div>
                <div class="text-end text-muted mt-1">
                  <i class="ti ti-checks ti-xs me-1 text-success"></i>
                  <small>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                </div>
              </div>
              <div class="user-avatar flex-shrink-0 ms-3">
                <div class="avatar avatar-sm">
                  <img src="{{image_path}}" alt="Avatar" class="rounded-circle" />
                </div>
              </div>
            </div>
          `;
    
          li.innerHTML = messageHtml;
          chatMessagesContainer.appendChild(li);
          messageInput.value = ''; // Clear the input field
          scrollToBottom(); // Ensure the chat scrolls to the bottom
        }
    });
        // Chat history scrollbar
    if (chatHistoryBody) {
      new PerfectScrollbar(chatHistoryBody, {
        wheelPropagation: false,
        suppressScrollX: true
      });
    }
    function scrollToBottom() {
      chatHistoryBody.scrollTo(0, chatHistoryBody.scrollHeight);
    }
  
    })
</script> {% endcomment %}
{% endblock footer_scripts %}